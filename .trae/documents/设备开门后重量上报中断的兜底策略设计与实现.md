# 设备开门后重量上报中断的兜底策略实现计划

## 1. 问题分析与核心需求
- **问题**：设备在开门状态下应每300ms上报一次重量信息，但可能因网络或设备故障导致重量上报中断
- **核心需求**：实现可靠的检测机制，及时发现重量上报中断情况，并采取相应的兜底措施
- **现有基础**：系统已有设备心跳检测、重量上报处理和设备状态管理机制

## 2. 实现方案设计

### 2.1 数据结构设计
- **Redis常量扩展**：新增用于存储开门状态下重量上报信息的常量
- **开门状态记录**：为每个开门状态的设备记录：
  - 最后重量上报时间戳
  - 开门状态持续时间
  - 超时次数统计
  - 相关订单信息

### 2.2 核心处理流程
1. **设备开门时**：记录开门时间和相关订单信息到Redis
2. **重量上报时**：更新最后重量上报时间
3. **定时检测**：每1秒扫描所有开门状态设备，检查重量上报是否超时
4. **超时处理**：根据超时级别执行不同处理（告警、设备状态更新、订单处理）

### 2.3 技术实现细节

#### 2.3.1 Redis常量扩展
- 在`RedisConstants`中新增以下常量：
  - `DEVICE_GATE_OPEN_STATUS`：设备开门状态key
  - `DEVICE_LAST_WEIGHT_REPORT_TIME`：设备最后重量上报时间key
  - `DEVICE_WEIGHT_REPORT_TIMEOUT_COUNT`：设备重量上报超时次数key

#### 2.3.2 现有代码修改
1. **设备开门处理**：
   - 修改`DeviceOperateBizImpl.createOrderOpenGate()`方法
   - 记录开门时间和订单信息到Redis

2. **重量上报处理**：
   - 修改`MqttMessageHandler.handleWeightReportMessage()`方法
   - 更新设备最后重量上报时间

3. **设备状态管理**：
   - 扩展`DeviceService`接口，增加开门状态管理方法

#### 2.3.3 新增功能模块
1. **定时检测任务**：
   - 创建`WeightReportTimeoutJob`类，每1秒执行一次
   - 扫描所有开门状态设备，检查重量上报时间
   - 根据超时时间执行不同处理

2. **超时处理逻辑**：
   - **轻度超时（5秒）**：记录告警日志
   - **中度超时（10秒）**：触发告警通知，尝试获取设备状态
   - **重度超时（30秒）**：强制处理订单，更新设备状态为异常

3. **订单兜底处理**：
   - 基于已有重量数据进行结算
   - 或取消订单并释放库存

## 3. 代码实现计划

### 3.1 扩展Redis常量
```java
// 在RedisConstants.java中添加
public static final String DEVICE_GATE_OPEN_STATUS = "DEVICE_GATE_OPEN_STATUS_";
public static final String DEVICE_LAST_WEIGHT_REPORT_TIME = "DEVICE_LAST_WEIGHT_REPORT_TIME_";
public static final String DEVICE_WEIGHT_REPORT_TIMEOUT_COUNT = "DEVICE_WEIGHT_REPORT_TIMEOUT_COUNT_";
```

### 3.2 修改设备开门处理
- **文件**：`container-device/src/main/java/cn/fuguang/device/biz/impl/DeviceOperateBizImpl.java`
- **修改点**：在开门成功后，记录开门状态到Redis

### 3.3 修改重量上报处理
- **文件**：`container-communicate/src/main/java/cn/fuguang/communicate/protocol/mqtt/handle/MqttMessageHandler.java`
- **修改点**：在`handleWeightReportMessage()`方法中，更新最后重量上报时间

### 3.4 实现定时检测任务
```java
// 新增文件：WeightReportTimeoutJob.java
@Component
public class WeightReportTimeoutJob {
    @Scheduled(fixedRate = 1000) // 每1秒执行一次
    public void checkWeightReportTimeout() {
        // 扫描所有开门状态设备
        // 检查最后重量上报时间
        // 执行超时处理
    }
}
```

### 3.5 实现超时处理逻辑
```java
// 新增文件：WeightReportTimeoutHandler.java
@Component
public class WeightReportTimeoutHandler {
    public void handleTimeout(String deviceSn, long timeoutSeconds) {
        if (timeoutSeconds < 5) {
            // 轻度超时，仅记录日志
        } else if (timeoutSeconds < 10) {
            // 中度超时，触发告警
        } else {
            // 重度超时，强制处理订单和设备状态
        }
    }
}
```

### 3.6 实现订单兜底处理
```java
// 在OrderBizImpl中新增方法
public void handleWeightReportTimeoutOrder(String orderId) {
    // 获取订单信息
    // 基于已有重量数据进行结算
    // 或取消订单并释放库存
}
```

## 4. 测试计划

### 4.1 单元测试
- 测试Redis常量扩展
- 测试开门状态记录和更新
- 测试重量上报时间更新
- 测试超时检测逻辑

### 4.2 集成测试
- 测试完整的处理流程：开门→重量上报→中断→检测→处理
- 测试不同超时级别的处理逻辑
- 测试设备恢复后的状态重置

### 4.3 模拟测试
- 模拟设备开门后重量上报中断场景
- 模拟不同超时时间的情况
- 测试系统的响应和处理效果

## 5. 部署与监控

### 5.1 部署计划
- 分阶段部署：先在测试环境验证，再灰度发布
- 监控上线后系统运行情况
- 及时调整超时阈值和处理逻辑

### 5.2 监控指标
- 开门状态设备数量
- 重量上报超时次数
- 告警触发频率
- 兜底处理订单数量

## 6. 预期效果

### 6.1 功能效果
- 实时检测设备开门后重量上报中断情况
- 多级处理机制确保系统稳定性
- 自动处理异常订单，减少人工干预
- 设备恢复后自动重置状态

### 6.2 性能效果
- 定时任务开销小，不影响系统性能
- Redis操作高效，支持大量设备并发
- 兜底处理逻辑可靠，确保数据一致性

### 6.3 业务效果
- 提高系统可靠性，减少因设备故障导致的订单异常
- 降低人工干预成本，提高运营效率
- 提升用户体验，减少订单处理延迟

## 7. 风险评估与应对

### 7.1 误判风险
- **风险**：网络波动可能导致误判
- **应对**：设置合理的超时阈值，考虑网络延迟因素

### 7.2 性能影响
- **风险**：定时任务可能影响系统性能
- **应对**：优化扫描逻辑，使用批量处理，限制每次扫描的设备数量

### 7.3 数据一致性
- **风险**：兜底处理可能导致数据不一致
- **应对**：使用分布式事务或最终一致性机制，确保订单和库存数据一致

## 8. 实现时间线

1. **第1天**：完成Redis常量扩展和现有代码修改
2. **第2天**：实现定时检测任务和超时处理逻辑
3. **第3天**：实现订单兜底处理和测试
4. **第4天**：部署测试环境并进行集成测试
5. **第5天**：灰度发布并监控运行情况

## 9. 代码结构调整

### 9.1 新增文件
- `WeightReportTimeoutJob.java`：定时检测任务
- `WeightReportTimeoutHandler.java`：超时处理逻辑
- `DeviceGateStatusManager.java`：开门状态管理

### 9.2 修改文件
- `RedisConstants.java`：扩展Redis常量
- `DeviceOperateBizImpl.java`：修改开门处理逻辑
- `MqttMessageHandler.java`：修改重量上报处理逻辑
- `DeviceService.java`：扩展设备状态管理接口

## 10. 关键技术点

- **Redis高效操作**：使用批量操作和管道技术，提高性能
- **定时任务优化**：使用合理的扫描策略，减少资源消耗
- **多级超时处理**：根据不同超时级别采取不同处理措施
- **可靠的订单处理**：确保兜底处理不会导致数据不一致

通过以上实现计划，可以有效解决设备开门后重量上报中断的问题，提高系统的可靠性和容错能力，确保业务的正常运行。