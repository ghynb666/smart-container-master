# 智能货柜Demo项目开发计划（更新版）

## 项目开发规则

1. **规则1**：本项目为个人学习用demo，功能实现以学习为主要目的
2. **规则2**：功能开发优先级基于其缺失对项目的影响程度评估结果确定
3. **规则3**：任何需要对接外部平台接口的功能，均采用模拟实现方式，不进行实际接口对接

## 一、功能缺失影响程度评估

### 1. 高影响程度功能（导致流程中断，核心功能无法使用）

| 功能名称      | 影响描述                    | 技术模块        | 状态    |
| --------- | ----------------------- | ----------- | ----- |
| 设备开仓门功能   | 预授权成功后无法打开仓门，用户无法取货     | 设备服务、通信服务   | 已实现   |
| 分布式锁释放功能  | 可能导致设备/仓门被永久锁定，影响后续用户使用 | 订单服务、分布式锁管理 | 已实现   |
| 重量对比与商品识别 | 无法确定用户实际购买的商品，无法完成真实支付  | 设备服务、重量数据处理 | 已实现   |
| 支付完成处理    | 订单无法正常完成，资金无法正常结算       | 订单服务、支付处理   | 已实现   |

### 2. 中影响程度功能（功能不完整，但不影响核心流程运行）

| 功能名称     | 影响描述           | 技术模块       | 状态    |
| -------- | -------------- | ---------- | ----- |
| 关门检测功能   | 无法自动检测用户是否关闭仓门 | 设备服务、传感器检测 | 已实现   |
| 实际支付金额计算 | 无法准确计算实际支付金额   | 订单服务、价格计算  | 已实现   |
| 前端扫码入口   | 用户无法发起购买请求     | 前端界面、API接口 | 已实现   |
| 库存扣减功能   | 无法自动更新商品库存     | 库存管理、订单服务  | 已实现   |

### 3. 低影响程度功能（细节功能缺失，对整体流程影响较小）

| 功能名称     | 影响描述          | 技术模块      | 状态    |
| -------- | ------------- | --------- | ----- |
| 优惠券/积分处理 | 无法处理用户优惠券和积分  | 营销服务、订单服务 | 已实现   |
| 消费记录生成   | 无法生成用户消费记录    | 订单服务、用户服务 | 已实现   |
| 补货触发功能   | 无法自动触发补货任务    | 设备服务、库存管理 | 已实现   |
| 订单通知功能   | 无法向用户发送订单完成通知 | 通知服务、订单服务 | 已实现   |

## 二、开发计划

### 1. 第一阶段：高影响程度功能开发（已完成）

#### 1.1 设备开仓门功能

* **开发顺序**：1
* **实现时间**：已完成
* **模拟实现方案**：
  * 在 `DeviceOperateBizImpl.createOrderOpenGate` 方法中添加模拟开仓门逻辑
  * 记录开仓门日志，模拟设备响应
  * 模拟设备响应延迟，增强真实感
  * 不实际调用通信服务，仅模拟成功响应

* **验收标准**：
  * 预授权成功后调用设备服务开仓门接口
  * 开仓门操作记录日志
  * 模拟设备响应延迟
  * 记录设备状态更新日志

#### 1.2 分布式锁释放功能

* **开发顺序**：2
* **实现时间**：已完成
* **模拟实现方案**：
  * 在 `OrderBizImpl.scanCreateOrder` 方法中添加finally块确保锁释放
  * 在 `agreementSignCallBack` 方法中添加预授权成功时的锁释放逻辑
  * 确保在所有场景下锁都能正确释放

* **验收标准**：
  * 预授权成功后正确释放分布式锁
  * 极端情况下（如异常）锁也能释放
  * 设备/仓门可以被其他用户正常使用

#### 1.3 重量对比与商品识别

* **开发顺序**：3
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `DeviceCloseGateEventProcessor` 类处理关门事件
  * 模拟开门前和关门后的重量数据
  * 基于重量差模拟识别用户购买的商品
  * 返回模拟的商品列表和数量

* **验收标准**：
  * 能接收开门前和关门后的重量数据
  * 能根据重量差识别出购买的商品
  * 返回正确的商品信息和数量

#### 1.4 支付完成处理

* **开发顺序**：4
* **实现时间**：已完成
* **模拟实现方案**：
  * 在 `OrderBizImpl` 中添加 `handlePayComplete` 方法
  * 完善订单状态流转逻辑
  * 模拟支付成功响应
  * 处理库存扣减、消费记录生成和积分增加

* **验收标准**：
  * 订单状态能从预授权成功流转到已支付
  * 支付完成后更新订单信息
  * 能处理购买商品信息
  * 能扣减库存、生成消费记录和增加积分

### 2. 第二阶段：中影响程度功能开发（已完成）

#### 2.1 关门检测功能

* **开发顺序**：5
* **实现时间**：已完成
* **模拟实现方案**：
  * 在 `DeviceCloseGateEventProcessor.doDeviceEvent` 方法中添加关门检测逻辑
  * 模拟检测到仓门关闭事件
  * 触发后续的重量对比和商品识别流程

* **验收标准**：
  * 能模拟检测到仓门关闭事件
  * 关闭事件能触发重量对比流程
  * 记录关门日志

#### 2.2 实际支付金额计算

* **开发顺序**：6
* **实现时间**：已完成
* **模拟实现方案**：
  * 在 `DeviceCloseGateEventProcessor` 中添加 `simulateCalculatePayAmount` 方法
  * 根据识别出的商品计算实际支付金额
  * 模拟商品价格数据
  * 返回计算结果

* **验收标准**：
  * 能根据商品列表计算总金额
  * 计算结果正确
  * 记录价格计算日志

#### 2.3 前端扫码入口

* **开发顺序**：7
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建简单的HTML页面 `scan.html` 模拟扫码功能
  * 提供订单创建API接口
  * 模拟用户扫码流程

* **验收标准**：
  * 前端页面能显示扫码界面
  * 能调用订单创建接口
  * 能显示订单创建结果

#### 2.4 库存扣减功能

* **开发顺序**：8
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `InventoryService` 和 `InventoryServiceImpl` 类
  * 模拟设备库存数据
  * 根据购买的商品扣减库存
  * 更新库存记录

* **验收标准**：
  * 能根据购买商品扣减库存
  * 库存数据更新正确
  * 记录库存变动日志
  * 能查询当前库存

### 3. 第三阶段：低影响程度功能开发（部分已完成）

#### 3.1 优惠券/积分处理功能

* **开发顺序**：9
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `CouponPointService` 和 `CouponPointServiceImpl` 类
  * 模拟优惠券和积分数据
  * 实现优惠券使用和积分增减逻辑

* **验收标准**：
  * 能模拟使用优惠券
  * 能模拟增减积分
  * 记录优惠券和积分变动日志
  * 能查询用户积分

#### 3.2 消费记录生成功能

* **开发顺序**：10
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `ConsumptionRecordService` 和 `ConsumptionRecordServiceImpl` 类
  * 生成用户消费记录
  * 记录消费详情

* **验收标准**：
  * 能生成消费记录
  * 消费记录信息完整
  * 记录消费日志
  * 能查询消费记录

#### 3.3 补货触发功能

* **开发顺序**：11
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `ReplenishmentService` 和 `ReplenishmentServiceImpl` 类
  * 模拟库存预警阈值
  * 当库存低于阈值时触发补货任务
  * 管理补货任务状态

* **验收标准**：
  * 能检测库存阈值
  * 能生成补货任务
  * 能更新补货任务状态
  * 记录补货日志
  * 能查询补货任务

#### 3.4 订单通知功能

* **开发顺序**：12
* **实现时间**：已完成
* **模拟实现方案**：
  * 创建 `NotificationService` 和 `NotificationServiceImpl` 类
  * 模拟订单通知功能，支持多种通知方式（短信、站内信等）
  * 在支付完成后触发订单通知
  * 记录通知日志
  * 模拟短信和站内信发送延迟

* **验收标准**：
  * 能发送订单通知
  * 通知内容正确
  * 支持多种通知方式
  * 记录通知日志
  * 支付完成后自动触发通知
  * 模拟通知发送延迟
  * 通知发送结果日志记录完整

## 三、开发技术栈

* 后端：Spring Boot 2.7.7、Spring Cloud 2021.0.5、MyBatis 2.2.2、Redis、Redisson、RocketMQ
* 前端：HTML、CSS、JavaScript
* 数据库：MySQL 8.0.33
* 开发工具：IDEA、Maven

## 四、开发注意事项

1. 所有功能实现均以模拟为主，不进行实际的外部接口对接
2. 重点关注功能流程的完整性和正确性
3. 保持代码的可扩展性，便于后续真实实现
4. 详细记录开发日志和测试结果
5. 遵循项目现有的代码规范和架构设计
6. 确保分布式锁的正确使用和释放，避免死锁问题
7. 事件处理逻辑要考虑异常情况，确保系统稳定性

## 五、验收标准

1. 每个功能模块都能按照设计要求正常工作
2. 功能之间的流程衔接顺畅
3. 系统运行稳定，无明显错误
4. 代码结构清晰，注释完整
5. 提供详细的测试报告和功能说明文档
6. 所有高、中影响程度的功能必须100%实现并通过测试
7. 低影响程度的功能至少实现80%以上

## 六、后续优化建议

1. 增加单元测试和集成测试，提高代码质量
2. 优化分布式锁的使用，减少锁冲突
3. 完善日志系统，便于问题定位和分析
4. 增加监控和告警功能，实时掌握系统运行状态
5. 优化数据库设计，提高查询性能
6. 增加缓存机制，减少数据库访问压力
7. 完善异常处理机制，提高系统容错能力

## 七、项目总结

本项目是一个智能货柜Demo，用于个人学习。项目采用了微服务架构，包括设备服务、订单服务、库存管理、支付处理等模块。目前已经实现了大部分核心功能，包括设备开仓门、分布式锁释放、重量对比与商品识别、支付完成处理等。后续将完成订单通知功能，并对系统进行优化和完善。

通过本项目的开发，可以学习到微服务架构设计、分布式锁管理、事件驱动架构、库存管理等技术要点。同时，项目采用了模拟实现的方式，避免了实际接口对接的复杂性，更加适合个人学习和演示。