# 智能货柜重量记录系统设计方案

## 一、架构设计

### 1. 系统架构图

```
┌───────────────────────────────────────────────────────────────────────────┐
│                             智能货柜设备                                  │
└─────────────────┬─────────────────────────────────────────────────────────┘
                  │ MQTT协议
                  ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                          通信服务 (container-communicate)                 │
│  ┌─────────────┐  ┌─────────────────────────────────────────────────────┐  │
│  │ MQTT服务端  │  │ 重量数据处理器                                      │  │
│  └─────────────┘  │  ┌───────────────┐  ┌───────────────┐  ┌───────────┐  │  │
│                   │  │ 消息解析模块   │→│ 数据缓存模块   │→│ MQ消息发送 │  │  │
│                   │  └───────────────┘  └───────────────┘  └───────────┘  │  │
│                   └─────────────────────────────────────────────────────┘  │
└─────────────────┬─────────────────────────────────────────────────────────┘
                  │ Redis缓存          │ RocketMQ
                  ├────────────────────┤
                  ▼                    ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                          设备服务 (container-device)                      │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 重量数据服务                                                        │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────────┐  │  │
│  │  │ 重量数据查询  │  │ 重量数据对比  │  │ 商品识别服务           │  │  │
│  │  └───────────────┘  └───────────────┘  └─────────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ MQ消息消费者                                                       │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────────┐  │  │
│  │  │ MQ消息接收    │→│ 数据解析       │→│ 数据库落库             │  │  │
│  │  └───────────────┘  └───────────────┘  └─────────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────┬─────────────────────────────────────────────────────────┘
                  │
                  ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                               数据库 (MySQL)                              │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2. 数据流程图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  智能货柜设备    │     │  MQTT消息接收   │     │  消息解析与验证  │
│                 │────►│                 │────►│                 │
│  - 关门状态：60s  │     │  topic: device/up/{SN} │  - 验证消息格式  │
│  - 开门状态：300ms │     │  QoS: 1         │  - 提取设备SN和重量数据 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                      │
                                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Redis缓存更新   │◄────│  数据缓存模块   │     │  RocketMQ消息发送 │
│                 │     │                 │────►│                 │
│  - Hash结构存储  │     │  - 先缓存后落库  │     │  - 异步发送落库消息 │
│  - 大key: WEIGHT_INFO │  - 缓存有效期管理  │     │  - 消息持久化     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                                 │
                                                                 ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  MQ消息接收     │◄────│  MQ消费者线程   │     │  数据落库处理   │
│                 │────►│                 │────►│                 │
│  - 监听落库主题  │     │  - 异步处理     │     │  - 批量插入     │
│  - 高可用设计   │     │  - 异常重试     │     │  - 事务管理     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                               数据库 (MySQL)                              │
└───────────────────────────────────────────────────────────────────────────┘
```

## 二、详细设计

### 1. 数据采集与上传策略

#### 1.1 设备端实现
- **关门状态**：每60秒向设备服务上传一次所有货道的重量信息
- **开门状态**：每300毫秒向设备服务上传重量信息
- **MQTT消息格式**：
  ```json
  {
    "messageType": "weightReport",
    "deviceSn": "设备SN码",
    "timestamp": 1234567890,
    "gateStatus": "0", // 0: 关门状态, 1: 开门状态
    "weightMap": {
      "1": 100,
      "2": 200,
      "3": 150
    }
  }
  ```

#### 1.2 服务端处理
- 接收设备MQTT消息，解析重量数据
- 根据设备状态（开门/关门）进行不同处理
- 实现"先缓存后落库"的数据持久化机制，落库操作通过RocketMQ异步处理

### 2. 数据存储设计

#### 2.1 Redis存储设计
- **数据结构**：Hash
- **大key**：`WEIGHT_INFO`（重量信息业务标识常量）
- **小key**：设备唯一标识SN码
- **数据值**：
  ```
  {
    "gateStatus": "0",
    "weightMap": {
      "1": 100,
      "2": 200,
      "3": 150
    },
    "lastUpdateTime": 1234567890
  }
  ```

#### 2.2 数据库存储设计
- **表结构**：优化现有的 `device_weight_record` 表
- **字段设计**：
  | 字段名 | 类型 | 描述 |
  |--------|------|------|
  | id | int | 主键ID |
  | device_sn | varchar(64) | 设备SN码 |
  | lane_uid | varchar(64) | 货道ID |
  | lane_weight | decimal(10,2) | 货道重量（g） |
  | gate_status | char(1) | 仓门状态（0:关门, 1:开门） |
  | weight_status | char(1) | 重量是否稳定（0:否, 1:是） |
  | create_date | datetime | 创建时间 |

### 3. 消息队列设计

#### 3.1 RocketMQ主题定义
- **主题名称**：`WEIGHT_DATA_STORAGE`
- **标签**：
  - `WEIGHT_REPORT`：重量上报数据落库
  - `WEIGHT_BATCH`：重量数据批量落库
- **消息格式**：
  ```json
  {
    "messageId": "消息唯一ID",
    "deviceSn": "设备SN码",
    "weightData": {
      "gateStatus": "0",
      "weightMap": {
        "1": 100,
        "2": 200,
        "3": 150
      },
      "timestamp": 1234567890
    },
    "createTime": 1234567890
  }
  ```

### 4. 接口定义

#### 4.1 MQTT主题定义
- **设备上报主题**：`device/up/{设备SN}`
- **设备控制主题**：`device/down/{设备SN}`

#### 4.2 服务接口

##### 4.2.1 重量数据接收接口
```java
/**
 * 接收设备重量上报数据
 * @param deviceSn 设备SN码
 * @param weightData 重量数据
 */
void receiveWeightReport(String deviceSn, WeightReportData weightData);
```

##### 4.2.2 重量数据查询接口
```java
/**
 * 查询设备当前重量信息
 * @param deviceSn 设备SN码
 * @return 设备重量信息
 */
DeviceWeightInfo queryCurrentWeight(String deviceSn);

/**
 * 查询设备历史重量记录
 * @param deviceSn 设备SN码
 * @param startTime 开始时间
 * @param endTime 结束时间
 * @return 历史重量记录列表
 */
List<DeviceWeightRecord> queryHistoryWeight(String deviceSn, Date startTime, Date endTime);
```

##### 4.2.3 重量数据缓存接口
```java
/**
 * 更新设备重量缓存
 * @param deviceSn 设备SN码
 * @param weightInfo 重量信息
 */
void updateWeightCache(String deviceSn, DeviceWeightInfo weightInfo);

/**
 * 获取设备重量缓存
 * @param deviceSn 设备SN码
 * @return 设备重量信息
 */
DeviceWeightInfo getWeightCache(String deviceSn);
```

##### 4.2.4 MQ消息发送接口
```java
/**
 * 发送重量数据落库消息
 * @param weightData 重量数据
 */
void sendWeightStorageMessage(WeightStorageMessage weightData);
```

### 5. 实现步骤

#### 5.1 第一步：优化数据模型
- 修改 `DeviceWeightBean`，增加设备SN码字段
- 创建 `WeightReportData` 类，用于接收设备上报的重量数据
- 创建 `WeightStorageMessage` 类，用于MQ消息传输
- 优化 `device_weight_record` 表结构

#### 5.2 第二步：实现RocketMQ配置
- 配置RocketMQ生产者和消费者
- 定义重量数据落库主题和标签
- 配置消息重试机制和死信队列

#### 5.3 第三步：实现重量数据接收与缓存
- 完善 `MqttMessageHandler.handleWeightReportMessage` 方法
- 实现重量数据的解析与验证
- 根据设备状态（开门/关门）进行不同处理
- 实现Redis Hash数据结构缓存

#### 5.4 第四步：实现MQ异步落库
- 实现重量数据的MQ消息发送逻辑
- 实现MQ消费者，处理重量数据落库
- 实现批量插入和事务管理
- 实现异常处理和重试机制

#### 5.5 第五步：实现重量数据服务
- 创建重量数据服务接口和实现
- 实现重量数据查询、对比和商品识别功能
- 集成到现有的业务流程中

#### 5.6 第六步：测试与验证
- 测试设备在不同状态下的重量数据采集与上传
- 验证Redis缓存和MQ消息发送的正确性
- 测试MQ消费者和数据库落库的正确性
- 测试重量对比和商品识别功能
- 进行性能测试，确保系统能够处理高频数据上报

## 三、预期效果

1. **提高数据采集的实时性**：开门状态下每300毫秒采集一次数据，能够更准确地捕捉用户取货过程中的重量变化
2. **优化数据存储结构**：使用Redis Hash结构存储重量信息，提高数据访问效率
3. **完善数据持久化机制**："先缓存后MQ异步落库"的机制确保数据不丢失，同时提高系统性能
4. **增强系统可靠性**：MQ消息持久化和异常重试机制提高系统的容错能力
5. **支持高并发处理**：异步处理模式能够更好地应对高频数据上报
6. **支持后续功能扩展**：清晰的架构设计和接口定义便于后续功能扩展和优化

## 四、风险评估与应对

1. **高频数据上报的性能风险**：
   - 应对措施：使用异步处理和批量插入，优化数据库索引，考虑分库分表策略

2. **Redis缓存容量风险**：
   - 应对措施：合理设置缓存有效期，定期清理过期数据，监控Redis内存使用情况

3. **设备网络不稳定风险**：
   - 应对措施：使用MQTT QoS 1确保消息可靠传输，设备端实现消息缓存和重发机制

4. **MQ消息堆积风险**：
   - 应对措施：优化消费者处理速度，增加消费者线程数，设置合理的消息过期时间

5. **数据一致性风险**：
   - 应对措施：实现缓存与数据库的数据同步机制，定期进行数据一致性检查

## 五、后续优化建议

1. 增加重量数据异常检测功能，及时发现设备故障
2. 实现重量数据的可视化监控，便于运营人员实时查看设备状态
3. 优化重量对比算法，提高商品识别的准确性
4. 增加设备远程配置功能，支持动态调整采集频率
5. 实现重量数据的趋势分析，支持预测性维护
6. 考虑使用时序数据库存储历史重量数据，提高查询性能

通过以上设计方案，可以实现符合指定要求的智能货柜重量记录系统，提高系统的实时性、可靠性和性能。